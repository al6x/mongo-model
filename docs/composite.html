<!DOCTYPE html>  <html> <head>   <title>composite.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="assignment.html">                 assignment.coffee               </a>                                           <a class="source" href="associations.html">                 associations.coffee               </a>                                           <a class="source" href="basics.html">                 basics.coffee               </a>                                           <a class="source" href="callbacks.html">                 callbacks.coffee               </a>                                           <a class="source" href="composite.html">                 composite.coffee               </a>                                           <a class="source" href="database.html">                 database.coffee               </a>                                           <a class="source" href="driver.html">                 driver.coffee               </a>                                           <a class="source" href="examples-spec.html">                 examples-spec.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="modifiers.html">                 modifiers.coffee               </a>                                           <a class="source" href="queries.html">                 queries.coffee               </a>                                           <a class="source" href="synchronous.html">                 synchronous.coffee               </a>                                           <a class="source" href="validations.html">                 validations.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               composite.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Composite <a href="model.html">Model</a>.</p>

<p>Models are just ordinary JavaScript Objects, so You can combine and mix it as You wish.
The only differences between Main and Embedded Models are:</p>

<ul>
<li>Main Model has the <code>_id</code> attribute.</li>
<li>Embedded Models doesn't have <code>_id</code>, but have <code>_parent</code> - the reference to the Main Model.</li>
</ul>

<p><strong>Note:</strong> if You wish <a href="callbacks.html">Callbacks</a> and <a href="validations.html">Validations</a> also works on Embedded
Models You should explicitly tell about it. By using <code>@embedded</code> keyword.</p>

<p>In this example we'll create simple Blog Application and see how to embed Comments into Post.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Model = </span><span class="nx">require</span> <span class="s1">&#39;mongo-model&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Enabling optional <a href="synchronous.html">synchronous</a> mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">require</span> <span class="s1">&#39;mongo-model/lib/sync&#39;</span>
<span class="nv">sync = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Connecting to default database and clearing it before starting.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">db = </span><span class="nx">Model</span><span class="p">.</span><span class="nx">db</span><span class="p">()</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Defining Post.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Post</span> <span class="k">extends</span> <span class="nx">Model</span>
    <span class="nx">@collection</span> <span class="s1">&#39;posts&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Telling Post that it have Embedded Comments.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@embedded</span> <span class="s1">&#39;comments&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Using plain JS Array as container for Comments.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">constructor: </span><span class="nf">(args...) -&gt;</span>
      <span class="vi">@comments = </span><span class="p">[]</span>
      <span class="k">super</span> <span class="nx">args</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Defining Comment.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Comment</span> <span class="k">extends</span> <span class="nx">Model</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>We need a way to access Post from Comment, every child object has <code>_parent</code> reference, let's
use it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">post: </span><span class="o">-&gt;</span> <span class="nx">@_parent</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Creating Post with Comments and saving it to database.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">post = </span><span class="k">new</span> <span class="nx">Post</span> <span class="nv">text: </span><span class="s1">&#39;Zerg infestation found on Tarsonis!&#39;</span>
  <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">(</span><span class="nv">text: </span><span class="s2">&quot;I can&#39;t believe it.&quot;</span><span class="p">)</span>
  <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Retrieving from database.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">post = </span><span class="nx">Post</span><span class="p">.</span><span class="nx">first</span><span class="p">()</span>
  <span class="nx">assert</span> <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span> <span class="nb">Array</span>
  <span class="nx">assert</span> <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span>
  <span class="nx">assert</span> <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">text</span><span class="p">,</span> <span class="s2">&quot;I can&#39;t believe it.&quot;</span>
  <span class="nx">assert</span> <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">post</span><span class="p">(),</span> <span class="nx">post</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Adding another comment.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">(</span><span class="nv">text: </span><span class="s2">&quot;Me too, but it&#39;s true.&quot;</span><span class="p">)</span>
  <span class="nx">post</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Reading updated post.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">post = </span><span class="nx">Post</span><span class="p">.</span><span class="nx">first</span><span class="p">()</span>
  <span class="nx">assert</span> <span class="nx">post</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Closing connection.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>This stuff needed for <a href="synchronous.html">synchronous</a> mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Fiber</span><span class="p">(</span><span class="nx">sync</span><span class="p">).</span><span class="nx">run</span><span class="p">()</span>

<span class="nv">global.assert = </span><span class="nf">(args...) -&gt;</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">).</span><span class="nx">deepEqual</span> <span class="nx">args</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>A little of Theory</h3>

<p>I believe good support for Composite Models is very important - because Complex Documents is one of
the strongest and most important features of MongoDB. Composite Documents for MongoDB is the same
as Relations are for Relational Database.</p>

<p>This <a href="model.html">Model</a> designed and optimized for working with such complex (also multi-nested) Models.</p>

<p>Composite Models by itself is very complicated stuff, so, in order to not to complicate it any further -
I tried to keep API as simple as possible.</p>

<p>There's no special Proxies, Collections or other stuff, only plain JS Objects, Arrays and Hashes.
So, You can safely combine this simple build blocks as You wish and be confident that all
this will not blow up at some point of complexity.</p>

<p>In this example we covered how to create and use Composite Models (Models with Embedded Models).</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html>